<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®—åƒæ¤œå®š èª²é•·ã‚³ãƒ¼ã‚¹ | å®—åƒã®é­…åŠ›ã‚’å†ç™ºè¦‹</title>
    <meta name="description" content="å®—åƒæ¤œå®šã€Œèª²é•·ã‚³ãƒ¼ã‚¹ã€ã«æŒ‘æˆ¦ï¼åŸºæœ¬æƒ…å ±ã‚’æ¥½ã—ãå­¦ã‚“ã§ã€å®—åƒã®é­…åŠ›ã‚’å†ç™ºè¦‹ã—ã‚ˆã†ã€‚">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/quiz.css">
    <style>
        /* Quiz Specific Overrides */
        .result-icon {
            display: inline-flex;
            width: 24px;
            height: 24px;
            background: var(--navy);
            color: white;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 8px;
        }

        .result-icon.success {
            background: var(--vermilion);
        }

        .review-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 12px;
            margin-right: 8px;
        }

        .review-icon.correct {
            background: var(--navy);
        }

        .review-icon.incorrect {
            background: #e74c3c;
        }

        .exam-section {
            display: none;
        }

        .exam-section.active {
            display: block;
        }

        #course-intro.hidden {
            display: none;
        }

        #result-section {
            display: none;
        }

        #result-section.active {
            display: block;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="site-header">
        <div class="header-container">
            <a href="../index.html" class="logo">
                <img src="../images/logo_mark.svg" onerror="this.style.display='none'" alt=""> å®—åƒæ¤œå®š
            </a>
            <ul class="nav-links">
                <li><a href="../index.html#concept">æ¤œå®šã¨ã¯</a></li>
                <li><a href="../index.html#courses">ã‚³ãƒ¼ã‚¹ç´¹ä»‹</a></li>
                <li><a href="../kanko/index.html">è¦³å…‰ç·¨</a></li>
            </ul>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>å®—åƒæ¤œå®š<br>èª²é•·ã‚³ãƒ¼ã‚¹</h1>
            <p>ã¾ãšã¯ã“ã“ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼<br>å®—åƒã®åŸºæœ¬æƒ…å ±ã‚’æ¥½ã—ãå­¦ã³ã¾ã—ã‚‡ã†ã€‚</p>
        </div>
    </section>

    <div class="container">
        <!-- ã‚³ãƒ¼ã‚¹ç´¹ä»‹ï¼ˆèª²é•·ã‚³ãƒ¼ã‚¹å°‚ç”¨ï¼‰ -->
        <div id="course-intro">
            <div class="difficulty-card beginner"
                style="cursor:default; transform:none; max-width:600px; margin:0 auto;">
                <img src="../images/course_kacho.webp" alt="èª²é•·ã‚³ãƒ¼ã‚¹" class="difficulty-icon"
                    style="width:320px; height:320px;" onerror="this.style.backgroundColor='#ccc'">
                <h3 style="font-size:1.8rem; margin-bottom:1rem;">èª²é•·ã‚³ãƒ¼ã‚¹</h3>

                <p style="margin-bottom:1.5rem; text-align:left; line-height:1.8;">
                    <strong>ã€ŒçŸ¥ã‚Œã°èª°ã‹ã«è©±ã—ãŸããªã‚‹ã€å®—åƒã®é­…åŠ›ã€‚</strong><br>
                    ä¸–ç•Œéºç”£ã€Œæ²–ãƒå³¶ã€ã®ç¥ç§˜ã‹ã‚‰ã€åœ°å…ƒã§æ„›ã•ã‚Œã‚‹çµ¶å“ã‚°ãƒ«ãƒ¡ã¾ã§ã€‚<br>
                    çŸ¥ã£ã¦ã„ã‚‹ã‚ˆã†ã§çŸ¥ã‚‰ãªã„å®—åƒã®ãƒˆãƒªãƒ“ã‚¢ã‚’ã€ã‚¯ã‚¤ã‚ºå½¢å¼ã§æ¥½ã—ãå­¦ã³ã¾ã›ã‚“ã‹ï¼Ÿ
                </p>

                <div
                    style="background:var(--off-white); padding:1.5rem; border-radius:12px; margin-bottom:2rem; text-align:left;">
                    <ul style="list-style:none; padding:0; margin:0;">
                        <li class="mb-2" style="display:flex; align-items:center; font-weight:bold;">
                            <span style="font-size:1.2rem; margin-right:0.5rem;">â±ï¸</span> æ‰€è¦æ™‚é–“ï¼šç´„3åˆ†ï¼ˆã‚µã‚¯ãƒƒã¨æŒ‘æˆ¦ï¼ï¼‰
                        </li>
                        <li class="mb-2" style="display:flex; align-items:center; font-weight:bold;">
                            <span style="font-size:1.2rem; margin-right:0.5rem;">ğŸ†“</span> å®Œå…¨ç„¡æ–™ãƒ»ç™»éŒ²ä¸è¦
                        </li>
                        <li class="mb-2" style="display:flex; align-items:center; font-weight:bold;">
                            <span style="font-size:1.2rem; margin-right:0.5rem;">ğŸ†</span> åˆæ ¼ã§ã€Œãƒ‡ã‚¸ã‚¿ãƒ«èªå®šè¨¼ã€ç™ºè¡Œ
                        </li>
                        <li style="display:flex; align-items:center; font-weight:bold;">
                            <span style="font-size:1.2rem; margin-right:0.5rem;">âœ…</span> åˆæ ¼ãƒ©ã‚¤ãƒ³ï¼šå…¨11å•ä¸­ 60ç‚¹ä»¥ä¸Š
                        </li>
                    </ul>
                </div>

                <button class="cta-button" onclick="startExam('beginner')"
                    style="font-size:1.2rem; padding:1.2rem 3rem; width:100%; max-width:400px; box-shadow:0 4px 12px rgba(216, 67, 21, 0.4);">
                    æ¤œå®šã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
                </button>
            </div>
        </div>

        <!-- èª²é•·ã‚³ãƒ¼ã‚¹è©¦é¨“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="beginner-exam" class="exam-section">
            <h2 class="section-title">èª²é•·ã‚³ãƒ¼ã‚¹ è©¦é¨“ä¸­</h2>
            <div id="beginner-questions"></div>
            <div class="text-center mt-4">
                <button class="cta-button" onclick="submitAnswers('beginner')">æ¡ç‚¹ã™ã‚‹</button>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="result-section">
            <div class="difficulty-card" style="cursor:default; transform:none;">
                <h2 style="font-family:'Noto Serif JP'; margin-bottom:1rem;">è©¦é¨“çµæœ</h2>
                <div id="result-message" style="font-size:1.2rem; font-weight:bold; margin-bottom:1rem;"></div>
                <div id="result-score" style="font-size:3rem; color:var(--vermilion); font-weight:bold;"></div>
                <div id="result-rank" style="color:var(--text-light);"></div>

                <div id="certificate-container" style="margin-top:2rem; display:none;">
                    <button class="cta-button" style="background:#4CAF50; margin-bottom:2rem;"
                        onclick="location.href='../kanko/index.html'">è¦³å…‰ç·¨ã«ã‚‚æŒ‘æˆ¦ï¼</button>

                    <div style="border:4px double var(--gold); padding:2rem; border-radius:8px; background:#fffcf5;">
                        <h3 style="color:var(--gold);">MUNAKATA KENTEI</h3>
                        <div id="certificate-badge-img" style="width:100px; height:100px; margin:1rem auto;"></div>
                        <div style="font-size:1.5rem; font-weight:bold; margin:0.5rem 0;">ãƒ‡ã‚¸ã‚¿ãƒ«èªå®šè¨¼</div>
                        <div id="certificate-level-name"></div>
                        <div style="margin-top:1rem; font-size:0.9rem; color:#888;" id="certificate-date"></div>
                    </div>
                </div>

                <div style="margin-top:2rem;">
                    <button class="cta-button" onclick="retryExam()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
                </div>
            </div>

            <div id="answer-review" style="margin-top:3rem;">
                <h3 style="border-bottom:2px solid var(--light-gray); padding-bottom:0.5rem;">å›ç­”ç¢ºèª</h3>
                <div id="review-content"></div>
            </div>
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // å•é¡Œãƒ‡ãƒ¼ã‚¿ (èª²é•·ã‚³ãƒ¼ã‚¹ã®ã¿ä½¿ç”¨)
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtUcELj-4klc6jorQS7Ez0YxuteN-Wv_k7bqGUlzY0RHypqY9xCG8cCFwMC6P9hCFtDO9jXjGKEzrM/pub?output=csv";
        let allQuestions = { "beginner": [] };

        async function initQuiz() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();
                const rows = parseCSV(text);

                // Header skip (check if first cell is ID)
                if (rows.length > 0 && (rows[0][0] === 'ID' || rows[0][0] === 'id')) {
                    rows.shift();
                }

                allQuestions["beginner"] = rows.map((row, index) => {
                    // Expected: ID,Question,Opt1,Opt2,Opt3,CorrectText,Explanation
                    // Minimum 7 columns
                    if (row.length < 7) return null;

                    const options = [row[2], row[3], row[4]];
                    const correctText = row[5];
                    // Find correct index by matching text
                    let correctIndex = options.findIndex(opt => opt.trim() === correctText.trim());
                    if (correctIndex === -1) {
                        // Fallback check (loose match)
                        correctIndex = options.findIndex(opt => correctText.includes(opt) || opt.includes(correctText));
                    }
                    if (correctIndex === -1) correctIndex = 0; // Ultimate fallback

                    return {
                        id: row[0] || `q${index + 1}`,
                        question: row[1],
                        options: options,
                        correct: correctIndex,
                        explanation: row[6]
                    };
                }).filter(q => q !== null);

                console.log("Quiz loaded:", allQuestions["beginner"].length, "questions");

            } catch (e) {
                console.error("Quiz load failed:", e);
                // Fallback static data could be placed here if needed
                alert("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
            }
        }

        // Robust CSV Parser
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuote = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuote && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuote = !insideQuote;
                    }
                } else if (char === ',' && !insideQuote) {
                    currentRow.push(currentCell.trim()); // Trim whitespace around cells
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !insideQuote) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentRow.length > 0 || currentCell.length > 0) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                    }
                } else {
                    currentCell += char;
                }
            }
            if (currentRow.length > 0 || currentCell.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows;
        }

        window.addEventListener('load', initQuiz);

        let currentScore = 0;

        function startExam(difficulty) {
            document.getElementById('course-intro').classList.add('hidden');
            document.getElementById('beginner-exam').classList.add('active');
            renderQuestions(difficulty);
            window.scrollTo(0, 0);
        }

        function renderQuestions(difficulty) {
            const questions = allQuestions[difficulty];
            const container = document.getElementById(difficulty + '-questions');
            container.innerHTML = '';

            questions.forEach((q, idx) => {
                const questionHTML = `
                    <div style="background:white; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; box-shadow:var(--shadow-sm);">
                        <div style="font-weight:bold; color:var(--text-light); margin-bottom:0.5rem;">ç¬¬${idx + 1}å•</div>
                        <div style="font-size:1.1rem; margin-bottom:1rem; font-weight:500;">${q.question}</div>
                        <div style="display:flex; flex-direction:column; gap:0.75rem;">
                            ${q.options.map((opt, optIdx) => `
                                <label style="display:flex; align-items:center; background:var(--off-white); padding:1rem; border-radius:8px; cursor:pointer;">
                                    <input type="radio" name="${q.id}" value="${optIdx}" style="margin-right:1rem;">
                                    <span>${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += questionHTML;
            });
        }

        function submitAnswers(difficulty) {
            const questions = allQuestions[difficulty];
            let score = 0;
            let answers = {};
            let isAllAnswered = true;

            questions.forEach(q => {
                const selected = document.querySelector(`input[name="${q.id}"]:checked`);
                if (selected) {
                    const answer = parseInt(selected.value);
                    answers[q.id] = {
                        selected: answer,
                        correct: q.correct,
                        isCorrect: answer === q.correct,
                        question: q.question,
                        options: q.options,
                        explanation: q.explanation
                    };
                    if (answer === q.correct) {
                        const pointsPerQuestion = Math.round(100 / questions.length * 100) / 100;
                        score += pointsPerQuestion;
                    }
                } else {
                    isAllAnswered = false;
                    answers[q.id] = { selected: -1, correct: q.correct, isCorrect: false, question: q.question, options: q.options, explanation: q.explanation };
                }
            });

            if (!isAllAnswered) {
                if (!confirm('æœªå›ç­”ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚æ¡ç‚¹ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            }

            currentScore = Math.round(score);
            displayResults(currentScore, difficulty, answers);
        }

        function displayResults(score, difficulty, answers) {
            document.getElementById(difficulty + '-exam').classList.remove('active');
            document.getElementById('result-section').classList.add('active');
            document.getElementById('result-score').textContent = score + 'ç‚¹';

            let message = '';
            let rank = '';
            const isPassed = score >= 60;

            if (score >= 80) {
                message = '<span class="result-icon success">â˜…</span> ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ï¼';
                rank = 'è©•ä¾¡: å„ªç§€ï¼ˆ80ç‚¹ä»¥ä¸Šï¼‰';
            } else if (score >= 60) {
                message = '<span class="result-icon success">âœ“</span> è‰¯å¥½ãªæˆç¸¾ã§ã™ï¼';
                rank = 'è©•ä¾¡: åˆæ ¼ï¼ˆ60ç‚¹ä»¥ä¸Šï¼‰';
            } else {
                message = '<span class="result-icon">!</span> ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼';
                rank = 'è©•ä¾¡: å†å—æ¤œæ¨å¥¨ï¼ˆ60ç‚¹æœªæº€ï¼‰';
            }

            document.getElementById('result-message').innerHTML = message;
            document.getElementById('result-rank').textContent = rank;

            if (isPassed) {
                document.getElementById('certificate-container').style.display = 'block';
                document.getElementById('certificate-level-name').textContent = 'èª²é•·ã‚³ãƒ¼ã‚¹';

                const today = new Date();
                document.getElementById('certificate-date').textContent = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

                document.getElementById('certificate-badge-img').innerHTML = `<img src="../images/course_kacho.webp" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
            } else {
                document.getElementById('certificate-container').style.display = 'none';
            }

            // è§£èª¬è¡¨ç¤º
            const reviewDiv = document.getElementById('review-content');
            reviewDiv.innerHTML = '';
            Object.values(answers).forEach((ans, idx) => {
                const icon = ans.isCorrect ? '<span class="review-icon correct">âœ“</span>' : '<span class="review-icon incorrect">âœ•</span>';
                const html = `
                    <div style="background:white; padding:1rem; border-radius:8px; margin-bottom:1rem; border-left:4px solid ${ans.isCorrect ? 'var(--cf-green)' : 'var(--vermilion)'}">
                        <div style="font-weight:bold; margin-bottom:0.5rem;">${icon} ç¬¬${idx + 1}å•: ${ans.question}</div>
                        <div style="font-size:0.9rem; color:#555; margin-bottom:0.5rem;">ã‚ãªãŸã®å›ç­”: ${ans.selected >= 0 ? ans.options[ans.selected] : 'æœªå›ç­”'} / æ­£è§£: ${ans.options[ans.correct]}</div>
                        <div style="font-size:0.9rem; background:var(--off-white); padding:0.5rem; border-radius:4px;">è§£èª¬: ${ans.explanation}</div>
                    </div>
                `;
                reviewDiv.innerHTML += html;
            });
            window.scrollTo(0, 0);
        }

        function retryExam() {
            document.getElementById('result-section').classList.remove('active');
            document.getElementById('course-intro').classList.remove('hidden');
            window.scrollTo(0, 0);
        }


    </script>
</body>

</html>